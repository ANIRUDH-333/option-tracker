<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copy Trading Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-card.success .value {
            color: #10b981;
        }

        .stat-card.warning .value {
            color: #f59e0b;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-indicator.running {
            background: #10b981;
        }

        .status-indicator.stopped {
            background: #ef4444;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .orders-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .orders-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .order-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .order-card.new {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }

        /* Flash effect for new orders */
        .notification-flash {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
            animation: flashNotification 3s ease-in-out;
            z-index: 1000;
            font-weight: 600;
        }

        @keyframes flashNotification {
            0% {
                opacity: 0;
                transform: translateX(100px);
            }

            15% {
                opacity: 1;
                transform: translateX(0);
            }

            85% {
                opacity: 1;
                transform: translateX(0);
            }

            100% {
                opacity: 0;
                transform: translateX(100px);
            }
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .order-symbol {
            font-size: 1.4em;
            font-weight: bold;
            color: #1f2937;
        }

        .order-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .order-badge.buy {
            background: #10b981;
            color: white;
        }

        .order-badge.sell {
            background: #ef4444;
            color: white;
        }

        .order-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .order-detail {
            padding: 8px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 5px;
        }

        .order-detail label {
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
            margin-bottom: 3px;
        }

        .order-detail value {
            font-size: 1.1em;
            font-weight: 600;
            color: #1f2937;
        }

        .order-time {
            text-align: right;
            color: #666;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .no-orders {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .no-orders-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .status-complete {
            color: #10b981;
        }

        .status-pending {
            color: #f59e0b;
        }

        .status-rejected {
            color: #ef4444;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>📊 Copy Trading Monitor</h1>
            <p>Real-time monitoring • 2-second polling (safe rate-limited)</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Monitor Status</h3>
                <div class="value">
                    <span class="status-indicator" id="statusIndicator"></span>
                    <span id="statusText">Loading...</span>
                </div>
            </div>

            <div class="stat-card success">
                <h3>Orders Detected</h3>
                <div class="value" id="ordersCount">0</div>
            </div>

            <div class="stat-card">
                <h3>Market Status</h3>
                <div class="value" id="marketStatus" style="font-size: 1.3em;">--</div>
            </div>

            <div class="stat-card">
                <h3>Last Check</h3>
                <div class="value" id="lastCheck" style="font-size: 1.2em;">--</div>
            </div>
        </div>

        <div class="orders-section">
            <h2>🔔 Latest Orders</h2>
            <div id="ordersContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Connecting to monitor...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let previousOrderCount = 0;

        // Fetch status
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();

                const indicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');

                if (status.running) {
                    indicator.className = 'status-indicator running';
                    statusText.textContent = 'Running';
                } else {
                    indicator.className = 'status-indicator stopped';
                    statusText.textContent = 'Stopped';
                }

                document.getElementById('ordersCount').textContent = status.orders_detected;
                document.getElementById('lastCheck').textContent = status.last_check || '--';

                const marketStatusEl = document.getElementById('marketStatus');
                if (status.market_hours) {
                    marketStatusEl.textContent = '🟢 OPEN';
                    marketStatusEl.style.color = '#10b981';
                } else {
                    marketStatusEl.textContent = '🔴 CLOSED';
                    marketStatusEl.style.color = '#ef4444';
                }
            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }

        // Fetch and display orders
        async function updateOrders() {
            try {
                const response = await fetch('/api/orders/latest');
                const orders = await response.json();

                const container = document.getElementById('ordersContainer');

                if (orders.length === 0) {
                    container.innerHTML = `
                        <div class="no-orders">
                            <div class="no-orders-icon">📭</div>
                            <h3>No orders detected yet</h3>
                            <p>Place an order in Angel One to see it appear here</p>
                        </div>
                    `;
                } else {
                    // Check if new order was added
                    const isNewOrder = orders.length > previousOrderCount;
                    previousOrderCount = orders.length;

                    container.innerHTML = orders.map((order, index) => {
                        const isNew = index === 0 && isNewOrder;
                        return `
                            <div class="order-card ${isNew ? 'new' : ''}">
                                <div class="order-header">
                                    <div class="order-symbol">${order.symbol}</div>
                                    <div class="order-badge ${order.transaction_type.toLowerCase()}">
                                        ${order.transaction_type}
                                    </div>
                                </div>
                                <div class="order-details">
                                    <div class="order-detail">
                                        <label>Order ID</label>
                                        <value>${order.order_id}</value>
                                    </div>
                                    <div class="order-detail">
                                        <label>Quantity</label>
                                        <value>${order.quantity}</value>
                                    </div>
                                    <div class="order-detail">
                                        <label>Price</label>
                                        <value>₹${order.price}</value>
                                    </div>
                                    <div class="order-detail">
                                        <label>Avg Price</label>
                                        <value>₹${order.average_price}</value>
                                    </div>
                                    <div class="order-detail">
                                        <label>Status</label>
                                        <value class="status-${order.status}">${order.status}</value>
                                    </div>
                                    <div class="order-detail">
                                        <label>Order Type</label>
                                        <value>${order.order_type}</value>
                                    </div>
                                    <div class="order-detail">
                                        <label>Product</label>
                                        <value>${order.product_type}</value>
                                    </div>
                                    <div class="order-detail">
                                        <label>Exchange</label>
                                        <value>${order.exchange}</value>
                                    </div>
                                </div>
                                <div class="order-time">🕐 ${order.time}</div>
                            </div>
                        `;
                    }).join('');

                    // Play sound and show visual notification for new order
                    if (isNewOrder && previousOrderCount > 1) {
                        playNotificationSound();
                        showVisualNotification(`New Order: ${data[0].symbol} - ${data[0].transaction_type}`);
                    }
                }
            } catch (error) {
                console.error('Error fetching orders:', error);
            }
        }

        // Play notification sound
        function playNotificationSound() {
            try {
                // Create audio context and play a beep sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800; // Frequency in Hz
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);

                console.log('🔔 New order detected! (Audio played)');
            } catch (error) {
                console.log('🔔 New order detected! (Audio not available)');

                // Fallback: Show browser notification if available
                if ("Notification" in window && Notification.permission === "granted") {
                    new Notification("New Order Detected!", {
                        body: "A new trading order has been detected",
                        icon: "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='%23007bff' d='M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zM7 7V5a1 1 0 0 1 2 0v2h2a1 1 0 0 1 0 2H9v2a1 1 0 0 1-2 0V9H5a1 1 0 0 1 0-2h2z'/%3e%3c/svg%3e"
                    });
                }
            }
        }

        // Request notification permission on page load
        if ("Notification" in window && Notification.permission === "default") {
            Notification.requestPermission();
        }

        // Show visual notification
        function showVisualNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification-flash';
            notification.textContent = `🔔 ${message}`;

            // Add to page
            document.body.appendChild(notification);

            // Remove after animation
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Update every 2 seconds
        setInterval(() => {
            updateStatus();
            updateOrders();
        }, 2000);

        // Initial load
        updateStatus();
        updateOrders();
    </script>
</body>

</html>